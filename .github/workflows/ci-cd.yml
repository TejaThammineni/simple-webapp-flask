name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:

  checkout:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v3


  build:

    needs: checkout

    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Dependencies
      run: pip install -r requirements.txt


  test:

    needs: build

    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Dependencies
      run: pip install -r requirements.txt

    - name: Run Unit Tests
      run: pytest
      
      
  deploy:

    needs: test

    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to EC2

      uses: appleboy/ssh-action@master

      with:

        host: ${{ secrets.EC2_HOST }}

        username: ubuntu

        key: ${{ secrets.EC2_SSH_KEY }}

        script: |

          # ensure system packages (procps gives us pkill)
          sudo apt-get update && sudo apt-get install -y python3 python3-venv python3-pip git procps

          # clone repo if missing
          if [ ! -d ~/simple-webapp-flask ]; then
            git clone https://github.com/${{ github.repository }} ~/simple-webapp-flask
          fi

          cd ~/simple-webapp-flask
          git fetch --all && git reset --hard origin/master

          # create venv and install requirements
          python3 -m venv venv
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # stop any running instance (only if pkill exists)
          if command -v pkill >/dev/null 2>&1; then
            pkill -f app.py || true
          else
            echo "warning: pkill not available, skipping process cleanup"
          fi

          # start app using virtualenv python to ensure dependencies are available
          nohup venv/bin/python app.py > output.log 2>&1 &

